<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>

    <record id="view_partner_form" model="ir.ui.view">
        <field name="name">res.partner.form</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            <field name="website" position="after">
                <field name="product_ids" widget="many2many_tags"/>
            </field>
        </field>
    </record>

    <template id="mobile_order_view" name="Mobile Order View">
        <t t-call="website.layout">
            <div id="wrap">
                <div class="oe_structure">
                    <div class="container mt16 mb64" style="width: 100%; padding: 0px;">
                        <div class="col-md-12 col-sm-12">
                            <ul class="nav nav-tabs">
                                <li class="active">
                                    <a data-toggle="tab" href="#butiks_order">Butiksorder</a>
                                </li>
                                <li>
                                    <a data-toggle="tab" href="#kedjans_sortiment">Sortiment</a>
                                </li>
                                <li>
                                    <a data-toggle="tab" href="#kund_kort">Kundkort</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <!-- Butiksorder -->
                                <div class="tab-pane fade in active col-xs-12 col-md-12 col-lg-12" id="butiks_order" style="padding: 0px;">
                                    <div class="container mb64">
                                        <t t-set="product_categories" t-value="request.env['product.category'].search([('parent_id', '=', 2)], order='id')"/>
                                        <h2 class="text-center mb32" t-esc="partner.name"/>
                                        <!-- navigator -->
                                        <ul class="nav nav-tabs">
                                            <t t-foreach="product_categories" t-as="brand_categs">
                                                <li t-att-class="active if p_categs == product_categories[0] else ''">
                                                    <a data-toggle="tab" style="border-width: 0px;" t-att-href="'&#35;categs_%s' %brand_categs.id">
                                                        <img itemprop="image" class="img img-responsive" style="margin: auto; width: 100px;" t-att-src="'/website/image/product.category/%s/website_image/150x150' %brand_categs.id"/>
                                                    </a>
                                                </li>
                                            </t>
                                        </ul>
                                        <!-- content -->
                                        <div class="tab-content">
                                            <t t-foreach="product_categories" t-as="brand_categories">
                                                <div t-att-class="'tab-pane fade in active col-xs-12 col-md-12 col-lg-12' if brand_categories == product_categories[0] else 'tab-pane fade in col-xs-12 col-md-12 col-lg-12'"
                                                t-att-id="'categs_%s' %brand_categories.id" style="padding: 0px;">
                                                    <ul class="nav nav-tabs">
                                                        <t t-set="brand_categs" t-value="request.env['product.category'].search([('parent_id', '=', brand_categories.id)])"/>
                                                        <t t-foreach="brand_categs" t-as="p_categs">
                                                            <li t-att-class="'%s' %'active' if b_c == brand_categs[0] else ''">
                                                                <a data-toggle="tab" style="padding: 5px;" t-att-href="'&#35;product_categ_%s' %p_categs.id"><span t-field="p_categs.name" style="color: #FFA62B;"/></a>
                                                            </li>
                                                        </t>
                                                    </ul>
                                                    <div class="tab-content">
                                                        <t t-set="brand_categs" t-value="request.env['product.category'].search([('parent_id', '=', brand_categories.id)])"/>
                                                        <t t-foreach="brand_categs" t-as="p_categs">
                                                            <div t-att-class="'active tab-pane fade in table-responsive col-xs-12 col-md-12 col-lg-12'
                                                                if p_categs == brand_categs[0] else
                                                                'tab-pane fade in table-responsive col-xs-12 col-md-12 col-lg-12'"
                                                                t-att-id="'product_categ_%s' %p_categs.id" style="padding: 0px;">
                                                                <t t-foreach="p_categs" t-as="p_c">
                                                                    <t t-set="order_line" t-value="request.env['rep.order.line'].search([('order_id', '=', order.id)])"/>
                                                                    <table class="table" style="background-color: #FFA62B;">
                                                                        <thead>
                                                                            <tr>
                                                                                <th class="text-center" style="background-color: #000; color: #fff;">Products</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            <t t-foreach="products" t-as="p">
                                                                            <tr>
                                                                                <t t-if="p.categ_id in p_c">
                                                                                    <t t-set="order_line_qty" t-value="0"/>
                                                                                    <t t-set="order_line_discount" t-value="0"/>
                                                                                    <t t-foreach="order_line" t-as="ol">
                                                                                        <t t-if="ol.product_id.id == p.id">
                                                                                            <t t-set="order_line_qty" t-value="ol.product_uom_qty"/>
                                                                                            <t t-set="order_line_discount" t-value="ol.discount"/>
                                                                                        </t>
                                                                                    </t>
                                                                                    <td>
                                                                                        <div class="col-md-12 mb8">
                                                                                            <div class="col-md-12">
                                                                                                <h6 class="text-center">[<span t-field="p.default_code"/>]</h6>
                                                                                            </div>
                                                                                            <div class="col-md-12">
                                                                                                <h4 class="text-center mb16" t-att-onclick="'toggle_cell(&quot;%s&quot;)' %p.id" t-field="p.name"/>
                                                                                            </div>
                                                                                            <div class="col-md-12 input-group oe_website_spinner" style="margin: auto;">
                                                                                                <span class="input-group-addon" style="color: #fff; background-color: #f00;" t-att-onclick="'minus(&quot;%s_qty_%s&quot;); send_rep_order(&quot;%s&quot;, &quot;%s&quot;)' %(partner.id, p.id, partner.id, p.id)">
                                                                                                    <i class="fa fa-minus"/>
                                                                                                </span>
                                                                                                <span class="input-group-addon">Quantity: </span>
                                                                                                <input class="form-control" data-min="0" style="width: 50px;" t-att-id="'%s_qty_%s' %(partner.id, p.id)" t-att-onchange="'send_rep_order(&quot;%s&quot;, &quot;%s&quot;)' %(partner.id, p.id)" name="add_qty" t-att-value="'0' if order_line_qty == 0.0 else order_line_qty" type="number"/>
                                                                                                <span class="input-group-addon"><t t-esc="p.uom_id.name"/></span>
                                                                                                <span class="input-group-addon float_left" style="color: #fff; background-color: #0f0;" t-att-onclick="'plus(&quot;%s_qty_%s&quot;); send_rep_order(&quot;%s&quot;, &quot;%s&quot;)' %(partner.id, p.id, partner.id, p.id)">
                                                                                                    <i class="fa fa-plus"/>
                                                                                                </span>
                                                                                            </div>
                                                                                        </div>
                                                                                        <div class="table_cell" t-att-id="'product_cell_%s' %p.id">
                                                                                            <div class="col-md-12 input-group oe_website_spinner" style="margin: auto;">
                                                                                                <span class="input-group-addon" style="color: #fff; background-color: #f00;" t-att-onclick="'minus(&quot;%s_discount_%s&quot;); send_rep_order(&quot;%s&quot;, &quot;%s&quot;)' %(partner.id, p.id, partner.id, p.id)">
                                                                                                    <i class="fa fa-minus"/>
                                                                                                </span>
                                                                                                <span class="input-group-addon">Discount: </span>
                                                                                                <input class="form-control" style="width: 50px;" data-min="0" t-att-id="'%s_discount_%s' %(partner.id, p.id)" t-att-onchange="'send_rep_order(&quot;%s&quot;, &quot;%s&quot;)' %(partner.id, p.id)" name="discount" t-att-value="'0' if order_line_discount == 0.0 else order_line_discount" type="number"/>
                                                                                                <span class="input-group-addon">%</span>
                                                                                                <span class="input-group-addon float_left" style="color: #fff; background-color: #0f0;" t-att-onclick="'plus(&quot;%s_discount_%s&quot;); send_rep_order(&quot;%s&quot;, &quot;%s&quot;)' %(partner.id, p.id, partner.id, p.id)">
                                                                                                    <i class="fa fa-plus"/>
                                                                                                </span>
                                                                                            </div>
                                                                                            <ul class="mt16" style="list-style-type: none;">
                                                                                                <li>KFP: <span t-field="p.weight"/></li>
                                                                                                <t t-set="packaging_id" t-value="p.packaging_ids and p.packaging_ids[0]"/>
                                                                                                <t t-if="packaging_id">
                                                                                                    <li>DFP: <span t-field="packaging_id.qty"/></li>
                                                                                                    <li>PALL: <span t-field="packaging_id.ul_qty"/></li>
                                                                                                </t>
                                                                                                    <li>NR: <span t-esc="p.get_store_code(partner.id)"/></li>
                                                                                            </ul>
                                                                                        </div>
                                                                                    </td>
                                                                                </t>
                                                                            </tr>
                                                                            </t>
                                                                        </tbody>
                                                                    </table>
                                                                </t>
                                                            </div>
                                                        </t>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </div>
                                    <hr style="width: 100%"/>
                                    <div class="form-group">
                                        <div class="col-md-8">
                                            <label class="col-md-4 control-label" for="order_type">
                                                <span class="pull-right">Beställningstyp:</span>
                                            </label>
                                            <div class="col-md-8 mb16">
                                                <select name="order_type" id="order_type" class="form-control selectpicker dropup" data-style="btn-primary">
                                                    <t t-foreach="request.env['rep.order'].fields_get(['order_type'])['order_type']['selection']" t-as="order_type">
                                                        <option t-att-value="order_type[0]" t-att="{'selected': 'checked'} if order_type[0] == order.order_type else {}"><t t-raw="order_type[1]"/></option>
                                                    </t>
                                                </select>
                                            </div>
                                            <label class="col-md-4 control-label" for="leveransvecka">
                                                <span class="pull-right">Leveransvecka:</span>
                                            </label>
                                            <div class="col-md-8 mb16">
                                                <input id="delivery_date" name="Delivery Date" class="form-control" data-style="btn-primary"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <button id="spara" name="spara" class="btn btn-success btn-lg pull-right">Spara</button>
                                    </div>
                                </div>

                                <!-- Kedjans sortiment -->
                                <div id="kedjans_sortiment" class="tab-pane fade in col-xs-12 col-md-12 col-lg-12" style="padding: 0px;">
                                    <div class="container mb64">
                                        <h2 class="text-center mb32" t-esc="partner.parent_id.name"/>
                                        <t t-foreach="parent_products" t-as="pp">
                                            <t t-if="pp in partner.product_ids">
                                                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 mt8 mb8" style="padding: 10px 0px; background: #ddd;">
                                                    <div class="col-xs-6 col-sm-7 col-md-7 col-lg-7">
                                                        <img itemprop="image" class="img img-responsive" style="margin: auto;" t-att-src="'/website/image/product.product/%s/image/150x150' %pp.id"/>
                                                    </div>
                                                    <div class="col-xs-6 col-sm-5 col-md-5 col-lg-4 col-lg-offset-1">
                                                        <p class="text-center">
                                                            <t t-if="pp.default_code">
                                                                <span>[<t t-esc="pp.default_code"/>] </span>
                                                            </t>
                                                            <span class="text-center" t-field="pp.product_tmpl_id"/>
                                                        </p>
                                                        <div class="text-center" style="margin: auto;">
                                                            <i style="font-size: 2em;" class="fa fa-check"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                            <t t-if="pp not in partner.product_ids">
                                                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 mt8 mb8" style="padding: 10px 0px; background: #AAFCA9;">
                                                    <div class="col-xs-6 col-sm-7 col-md-7 col-lg-7">
                                                        <img itemprop="image" class="img img-responsive" style="margin: auto;" t-att-src="'/website/image/product.product/%s/image/150x150' %pp.id"/>
                                                    </div>
                                                    <div class="col-xs-6 col-sm-5 col-md-5 col-lg-4 col-lg-offset-1">
                                                        <p class="text-center">
                                                            <t t-if="pp.default_code">
                                                                <span>[<t t-esc="pp.default_code"/>] </span>
                                                            </t>
                                                            <span class="text-center" t-field="pp.product_tmpl_id"/>
                                                        </p>
                                                        <div class="text-center" style="margin: auto;">
                                                            <a href="#"><i class="fa fa-plus" style="font-size: 2em;"></i></a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                        </t>
                                    </div>
                                </div>

                                <!-- Kundkort -->
                                <div id="kund_kort" class="tab-pane fade in col-xs-12 col-md-12 col-lg-12" style="padding: 0px;">
                                    <div class="row">
                                        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 mt8 mb8">
                                            <div class="col-xs-12 mb8">
                                                <span t-field="partner.image" t-field-options="{&quot;widget&quot;: &quot;image&quot;}"/>
                                            </div>
                                            <h4 t-field="partner.name"/>
                                            <p>GLN Nr: <t t-esc="partner.gs1_gln"/></p>
                                            <p>Telephone: <t t-esc="partner.phone"/></p>
                                            <p>Email: <t t-esc="partner.email"/></p>
                                            <p>Reference Nr: <t t-esc="partner.ref"/></p>
                                            <p>Address: <t t-esc="partner.street"/></p>
                                            <p><t t-esc="partner.zip"/>  <t t-esc="partner.city"/></p>
                                            <t t-if="partner.child_ids">
                                                <t t-foreach="partner.child_ids" t-as="c">
                                                    <p><i class="fa fa-user"/> <t t-esc="c.name"/></p>
                                                    <p><i class="fa fa-phone"/> <t t-esc="c.phone"/></p>
                                                </t>
                                            </t>
                                            <t t-set="notes" t-value="request.env['note.note'].sudo().search(['&amp;', '&amp;', ('partner_id', '=', partner.id), ('open', '=', True), ('stage_id', '!=', request.env.ref('note.note_stage_04').id)])"/>
                                            <t t-foreach="notes" t-as="note">
                                                <div t-att-id="'note_%s' %note.id" t-att-onclick="'todo_done(&quot;%s&quot;)' %note.id" class="mb8" style="border: 2px solid #369;">
                                                    <p t-att-id="'note_%s_text' %note.id" t-field="note.name" style="padding: 5px; margin: 0px;"/>
                                                </div>
                                            </t>
                                            <t t-set="meetings" t-value="request.env['calendar.event'].search([])"/>
                                            <t t-foreach="meetings" t-as="m">
                                                <t t-if="partner in m.partner_ids">
                                                    <t t-if="request.env.ref('crm_repord.categ_meet6') not in m.categ_ids">
                                                        <button t-att-id="'%s_meeting' %partner.id" t-att-onclick="'customer_visited(&quot;%s&quot;)' %partner.id" class="btn btn-success">Customer Visited</button>
                                                    </t>
                                                </t>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="crm_css" inherit_id="website.layout">
        <xpath expr="//t[@t-call-assets='website.assets_frontend']" position="after">
            <style>
                input[type=number]::-webkit-inner-spin-button,
                input[type=number]::-webkit-outer-spin-button {
                    -webkit-appearance: none;
                    margin: 0;
                }
                input[type='number'] {
                    -moz-appearance:textfield;
                }
            </style>
        </xpath>
    </template>

    <template id="crm_javascript" inherit_id="website.layout">
        <xpath expr="//body" position="inside">
            <script>

                function minus(product_id)
                {
                    value = parseInt(document.getElementById(product_id).value)
                    if(value &gt; 0){
                        value --;
                        document.getElementById(product_id).value = value;
                    }
                }

                function plus(product_id)
                {
                    value = parseInt(document.getElementById(product_id).value) + 1;
                    document.getElementById(product_id).value = value;
                }

                $(".table_cell").hide();
                function toggle_cell(product_id)
                {
                    var product = "product_cell_" + product_id;
                    $("#" + product).slideToggle("slow");
                }

                /* send rep.order */
                function send_rep_order(res_partner, product_id){
                    quantity = res_partner + "_qty_" +product_id;
                    discount = res_partner + "_discount_" +product_id;
                    document.getElementById(quantity).value
                    openerp.jsonRpc("/crm/send/repord", 'call', {
                        'res_partner': res_partner,
                        'product_id': product_id,
                        'product_uom_qty': document.getElementById(quantity).value,
                        'discount': document.getElementById(discount).value
                    });
                }

                /* change todo list to done */
                function todo_done(note_id){
                    note_text = "note_" + note_id + "_text";
                    openerp.jsonRpc("/crm/todo/done", 'call', {
                        'note_id': note_id,
                    });
                    $("#" + note_text).css("text-decoration", "line-through");
                }

                /* change status of meeting */
                function customer_visited(partner_id){
                    button = partner_id + "_meeting";
                    openerp.jsonRpc("/crm/meeting/visited", 'call', {
                        'partner_id': partner_id,
                    });
                    $("#" + button).addClass("hidden");
                }

            </script>
        </xpath>
    </template>

    </data>
</openerp>
